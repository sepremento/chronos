# Chronos

Простой тайм-трекер для учёта времени и задач. Предназначен для расширения на
различные интерфейсы. Код находится в `src/chronologger.py`. Файл `chronos`
содержит pyrogram-приложение для взаимодействия с API Telegram.

Установка `pyrogram`:

```
pip install pyrogram
```

Настройка параметров для работы приложения описана в разделе [Quick
Start](https://docs.pyrogram.org/intro/quickstart) документации pyrogram. Для
работы нужно получить секреты `API_ID` и `API_HASH`


Секреты подтягиваются из переменных окружения `TELEGRAM_API_ID` и
`TELEGRAM_API_HASH`. 

## Команды Chronos в Telegram

Чтобы получить статус ваших задач и повзаимодействовать с приложением с
минимальными последствиями, просто отправьте себе в личные сообщения точку
(`.`). Если запущенных задач нет, приложение скажет вам об этом, в противном
случае появится список выполняемых задач.

Каждое сообщение, отправляемое приложением живёт 8 секунд и затем удаляется.

Допустимо добавлять одновременно три задачи для отслеживания. Нумерация задач
ведётся от нуля. Таким образом, например `. с 0` завершит первую задачу в вашем
списке.

- `.[описание].[тег[,тег[, ...]]][. время_начала (ЧЧ:ММ)][. время_завершения (ЧЧ:ММ)]` -
добавление задачи. Между точками может быть произвольное количество пробельных
символов. Внутри описания точки недопустимы и будут интерпретированы как
разделители.
- `. у [номер задачи]` - удалить задачу. Если номер не задан, то подразумевается
    нулевая задача.
- `. с [номер задачи]` - остановить (стоп) отслеживание и зафиксировать задачу.
    Если номер задачи не задан, то подразумевается нулевая задача.
- `. тд [номер задачи] тег` - добавить тег к задаче с указанным номером. Если
    номер не задан, то подразумевается нулевая задача.
- `. ту [номер задачи] тег` - удалить тег у задачи с указанным номером. Если
    номер не задан, то подразумевается нулевая задача.
- `. о [номер задачи] описание` - изменить описание у задачи с указанным
    номером. Если номер не задан, то подразумевается нулевая задача.
- `. в [номер задачи] [время_начала (ЧЧ:ММ)][, время_завершения (ЧЧ:ММ)]` - изменить время
    начала и/или завершения задачи с указанным номером. Если номер не указан, то
    подразумевается нулевая задача.
- `. л [количество задач]` - показать список последних зафиксированных задач. По
    умолчанию возвращаются три последние задачи.

## Примеры

- `. ем еду . завтрак ` - добавит задачу с описанием "ем еду" и тегом "завтрак"
- `.. безделье, youtube` - добавит задачу без описания с тегами "безделье" и
    "youtube".
- `... 10:30 . 10:45` - добавит задачу без описания и тегов с началом в 10:30 и
    временем завершения 10:45. Обратите внимание, что задача будет храниться как
    активная до тех пор, пока не будет явна завершена через `. c [номер задачи]`
- `. в 2 13:45` - изменит время начала второй задачи (считая от нуля) на 13:45
- `. в , 18:20` - изменит время завершения нулевой задачи на 18:20 (полезно,
    если забыли отметить время завершения).


## Хранение данных

При первом запуске в директории приложения будет создана директория `./data/`, в
которой, содержащая файлы логов (с названием `%Y-%m.json`) и файл буфера для
хранения текущих задач (файл `.buf`). Все записи представляют собой простой
JSON.

## Оформление в виде сервиса

Секреты можно прописать в обычном файле в формате `key=value`, а затем описать
службу systemd в директории `/etc/systemd/system/`. Здесь для примера файл
расположен в `/etc/systemd/system/chronos.service`:

```
[Unit]
Description=Chronometer for daily tasks
After=multi-user.target

[Service]
Type=simple
Restart=always
EnvironmentFile=<<путь до файла с секретами>>
ExecStart=<<путь до исполняемого файла chronos>>

[Install]
WantedBy=multi-user.target
```

Затем запустить только что созданную службу `chronos`:

```bash
sudo systemctl daemon-reload
sudo systemctl start chronos.service
sudo systemctl status chronos.service  # проверяем, что запустилось
```

Для контроля за работой программы можно смотреть журналы systemd:

```bash
journalctl -u chronos.service -f
```
